name: Build and Push cli2rest-rchie image

on:
  schedule:
    # Weekly refresh (staleness window is 7 days)
    - cron: '30 1 * * 0'
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest R4RNA version from Bioconductor
        id: get_r4rna_version
        run: |
          R4RNA_INFO=$(curl -s https://bioconductor.org/packages/release/bioc/src/contrib/PACKAGES | grep -A 1 "^Package: R4RNA$")
          R4RNA_VERSION=$(echo "$R4RNA_INFO" | grep "^Version:" | awk '{print $2}')
          if [ -z "$R4RNA_VERSION" ]; then
            echo "Error: Could not fetch R4RNA version."
            exit 1
          fi
          echo "Latest R4RNA version: $R4RNA_VERSION"
          echo "version=$R4RNA_VERSION" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Get latest svgcleaner tag
        id: get_svgcleaner_version
        run: |
          LATEST_TAG_WITH_V=$(git ls-remote --tags --sort="v:refname" https://github.com/RazrFalcon/svgcleaner.git 'v*' | tail -n1 | sed 's/.*\///; s/\^{}//')
          LATEST_TAG=${LATEST_TAG_WITH_V#v}
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not fetch svgcleaner version."
            exit 1
          fi
          echo "Latest svgcleaner tag (with v): $LATEST_TAG_WITH_V"
          echo "Latest svgcleaner tag (without v): $LATEST_TAG"
          echo "version=$LATEST_TAG" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Compute upstream version
        id: get_version
        run: |
          echo "upstream=${{ steps.get_r4rna_version.outputs.version }}_${{ steps.get_svgcleaner_version.outputs.version }}" >> "$GITHUB_OUTPUT"

      - name: Install registry tooling
        if: github.event_name != 'pull_request'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends skopeo jq

      - name: Decide whether to rebuild
        id: decide
        if: github.event_name != 'pull_request'
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/tzok/cli2rest-rchie"
          UPSTREAM="${{ steps.get_version.outputs.upstream }}"
          VERSION_REF="$IMAGE:$UPSTREAM"
          LATEST_REF="$IMAGE:latest"

          STALE_SECONDS=$((7*24*60*60))
          NOW_EPOCH="$(date -u +%s)"
          REBUILD_SUFFIX="r$(date -u +%Y%m%d%H%M%S)"

          should_build=false
          build_tag=""
          should_promote=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            should_build=true
            build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
          elif ! docker manifest inspect "$VERSION_REF" >/dev/null 2>&1; then
            should_build=true
            build_tag="$UPSTREAM"
          else
            if docker manifest inspect "$LATEST_REF" >/dev/null 2>&1; then
              latest_json="$(skopeo inspect "docker://$LATEST_REF")"
              latest_upstream="$(echo "$latest_json" | jq -r '.Labels["org.cli2rest.upstream"] // ""')"
              latest_created="$(echo "$latest_json" | jq -r '.Created // ""')"

              if [[ -n "$latest_created" ]]; then
                created_epoch="$(date -u -d "$latest_created" +%s || echo 0)"
                age=$((NOW_EPOCH - created_epoch))
                if [[ "$age" -ge "$STALE_SECONDS" ]]; then
                  should_build=true
                  build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
                elif [[ "$latest_upstream" != "$UPSTREAM" ]]; then
                  should_promote=true
                fi
              else
                should_build=true
                build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
              fi
            else
              should_promote=true
            fi
          fi

          echo "should_build=$should_build" >> "$GITHUB_OUTPUT"
          echo "build_tag=$build_tag" >> "$GITHUB_OUTPUT"
          echo "should_promote=$should_promote" >> "$GITHUB_OUTPUT"
          echo "upstream=$UPSTREAM" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Build and Push Docker image
        if: github.event_name == 'pull_request' || steps.decide.outputs.should_build == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./rchie
          build-args: |
            R4RNA_VERSION=${{ steps.get_r4rna_version.outputs.version }}
            SVGCLEANER_VERSION=${{ steps.get_svgcleaner_version.outputs.version }}
          push: ${{ github.event_name != 'pull_request' }}
          load: true
          labels: |
            org.cli2rest.upstream=${{ steps.decide.outputs.upstream }}
            org.opencontainers.image.revision=${{ github.sha }}
          tags: |
            ${{ github.event_name == 'pull_request' && 'ghcr.io/tzok/cli2rest-rchie:test' || '' }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/tzok/cli2rest-rchie:{0}', steps.decide.outputs.build_tag) || '' }}
            ${{ github.event_name != 'pull_request' && 'ghcr.io/tzok/cli2rest-rchie:latest' || '' }}
          cache-from: type=gha,ref=ghcr.io/tzok/cli2rest-rchie:latest
          cache-to: type=gha,mode=max

      - name: Test Docker image
        if: github.event_name == 'pull_request' || steps.decide.outputs.should_build == 'true'
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEST_IMAGE="ghcr.io/tzok/cli2rest-rchie:test"
          else
            TEST_IMAGE="ghcr.io/tzok/cli2rest-rchie:${{ steps.decide.outputs.build_tag }}"
          fi

          docker run --name cli2rest-rchie-test -d -p 8000 "$TEST_IMAGE"
          sleep 5
          HOST_PORT=$(docker port cli2rest-rchie-test 8000 | cut -d: -f2)
          curl -s "http://localhost:$HOST_PORT/health" | grep '"status":"healthy"'

          pip install .
          cat > example.json << 'EOF'
          {
            "sequence": "GCAUUGC",
            "top": [
              {
                "i": 1,
                "j": 7
              },
              {
                "i": 2,
                "j": 6
              }
            ],
            "bottom": []
          }
          EOF

          cli2rest-bio --api-url "http://localhost:$HOST_PORT" --output-metadata metadata.json src/cli2rest_bio/configs/rchie/config.yaml example.json
          if [ "$(jq -r .status metadata.json)" != "COMPLETED" ]; then
            echo "Test failed: Job status is not COMPLETED"
            cat metadata.json
            exit 1
          fi

          if [ ! -f "rchie-example-clean.svg" ]; then
            echo "Test failed: Output file rchie-example-clean.svg is missing."
            ls -l
            exit 1
          fi

          echo "Test passed: All output files created."

          docker rm -f cli2rest-rchie-test

      - name: Promote latest to current upstream
        if: github.event_name != 'pull_request' && steps.decide.outputs.should_build != 'true' && steps.decide.outputs.should_promote == 'true'
        run: |
          IMAGE="ghcr.io/tzok/cli2rest-rchie"
          UPSTREAM="${{ steps.decide.outputs.upstream }}"

          echo "Promoting $IMAGE:$UPSTREAM -> $IMAGE:latest"
          docker buildx imagetools create -t "$IMAGE:latest" "$IMAGE:$UPSTREAM"
