name: Build and Push cli2rest-fr3d image

on:
  schedule:
    # Weekly refresh (staleness window is 7 days)
    - cron: '0 1 * * 0'
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        branch: [latest, master]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest FR3D commit hash
        id: get_version
        run: |
          LATEST_COMMIT=$(git ls-remote https://github.com/BGSU-RNA/fr3d-python.git ${{ matrix.branch }} | cut -f1)
          SHORT_COMMIT=${LATEST_COMMIT:0:7}
          UPSTREAM="${{ matrix.branch }}-${SHORT_COMMIT}"

          echo "Latest FR3D commit for ${{ matrix.branch }}: $LATEST_COMMIT"
          echo "commit_hash=$LATEST_COMMIT" >> "$GITHUB_OUTPUT"
          echo "short_commit=$SHORT_COMMIT" >> "$GITHUB_OUTPUT"
          echo "upstream=$UPSTREAM" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Install registry tooling
        if: github.event_name != 'pull_request'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends skopeo jq

      - name: Decide whether to rebuild
        id: decide
        if: github.event_name != 'pull_request'
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/tzok/cli2rest-fr3d"
          UPSTREAM="${{ steps.get_version.outputs.upstream }}"
          VERSION_REF="$IMAGE:$UPSTREAM"
          FLOATING_REF="$IMAGE:${{ matrix.branch }}"

          STALE_SECONDS=$((7*24*60*60))
          NOW_EPOCH="$(date -u +%s)"
          REBUILD_SUFFIX="r$(date -u +%Y%m%d%H%M%S)"

          should_build=false
          build_tag=""
          should_promote=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            should_build=true
            build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
          elif ! docker manifest inspect "$VERSION_REF" >/dev/null 2>&1; then
            should_build=true
            build_tag="$UPSTREAM"
          else
            if docker manifest inspect "$FLOATING_REF" >/dev/null 2>&1; then
              floating_json="$(skopeo inspect "docker://$FLOATING_REF")"
              floating_upstream="$(echo "$floating_json" | jq -r '.Labels["org.cli2rest.upstream"] // ""')"
              floating_created="$(echo "$floating_json" | jq -r '.Created // ""')"

              if [[ -n "$floating_created" ]]; then
                created_epoch="$(date -u -d "$floating_created" +%s || echo 0)"
                age=$((NOW_EPOCH - created_epoch))
                if [[ "$age" -ge "$STALE_SECONDS" ]]; then
                  should_build=true
                  build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
                elif [[ "$floating_upstream" != "$UPSTREAM" ]]; then
                  should_promote=true
                fi
              else
                should_build=true
                build_tag="${UPSTREAM}-${REBUILD_SUFFIX}"
              fi
            else
              should_promote=true
            fi
          fi

          echo "should_build=$should_build" >> "$GITHUB_OUTPUT"
          echo "build_tag=$build_tag" >> "$GITHUB_OUTPUT"
          echo "should_promote=$should_promote" >> "$GITHUB_OUTPUT"
          echo "upstream=$UPSTREAM" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Build and Push Docker image
        if: github.event_name == 'pull_request' || steps.decide.outputs.should_build == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./fr3d
          build-args: |
            FR3D_BRANCH=${{ matrix.branch }}
          push: ${{ github.event_name != 'pull_request' }}
          load: true
          labels: |
            org.cli2rest.upstream=${{ steps.get_version.outputs.upstream }}
            org.opencontainers.image.revision=${{ github.sha }}
          tags: |
            ${{ github.event_name == 'pull_request' && format('ghcr.io/tzok/cli2rest-fr3d:test-{0}', matrix.branch) || '' }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/tzok/cli2rest-fr3d:{0}', steps.decide.outputs.build_tag) || '' }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/tzok/cli2rest-fr3d:{0}', matrix.branch) || '' }}
          cache-from: type=gha,ref=ghcr.io/tzok/cli2rest-fr3d:${{ matrix.branch }}
          cache-to: type=gha,mode=max

      - name: Test Docker image
        if: github.event_name == 'pull_request' || steps.decide.outputs.should_build == 'true'
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEST_IMAGE="ghcr.io/tzok/cli2rest-fr3d:test-${{ matrix.branch }}"
          else
            TEST_IMAGE="ghcr.io/tzok/cli2rest-fr3d:${{ steps.decide.outputs.build_tag }}"
          fi

          docker run --name cli2rest-fr3d-test-${{ matrix.branch }} -d -p 8000 "$TEST_IMAGE"
          sleep 5
          HOST_PORT=$(docker port cli2rest-fr3d-test-${{ matrix.branch }} 8000 | cut -d: -f2)
          curl -s "http://localhost:$HOST_PORT/health" | grep '"status":"healthy"'

          pip install .
          curl -L -o 1ehz.cif https://files.rcsb.org/download/1EHZ.cif

          cli2rest-bio --api-url "http://localhost:$HOST_PORT" --output-metadata metadata.json src/cli2rest_bio/configs/fr3d/config.yaml 1ehz.cif
          if [ "$(jq -r .status metadata.json)" != "COMPLETED" ]; then
            echo "Test failed: Job status is not COMPLETED"
            cat metadata.json
            exit 1
          fi

          for f in fr3d-1ehz-basepair_detail.txt fr3d-1ehz-stacking.txt fr3d-1ehz-backbone.txt; do
            if [ ! -f "$f" ]; then
              echo "Test failed: Output file $f is missing."
              ls -l
              exit 1
            fi
          done

          echo "Test passed: All output files created."

          docker rm -f cli2rest-fr3d-test-${{ matrix.branch }}

      - name: Promote floating tag to current upstream
        if: github.event_name != 'pull_request' && steps.decide.outputs.should_build != 'true' && steps.decide.outputs.should_promote == 'true'
        run: |
          IMAGE="ghcr.io/tzok/cli2rest-fr3d"
          UPSTREAM="${{ steps.decide.outputs.upstream }}"

          echo "Promoting $IMAGE:$UPSTREAM -> $IMAGE:${{ matrix.branch }}"
          docker buildx imagetools create -t "$IMAGE:${{ matrix.branch }}" "$IMAGE:$UPSTREAM"
